DELIMITER $$
CREATE PROCEDURE TOP3ACC() 
BEGIN

DECLARE done INT DEFAULT 0;

DECLARE F1 INT DEFAULT NULL;
DECLARE F2 INT DEFAULT NULL;
DECLARE F3 INT DEFAULT NULL;

DECLARE F1_ACC INT DEFAULT NULL;
DECLARE F2_ACC INT DEFAULT NULL;
DECLARE F3_ACC INT DEFAULT NULL;

DECLARE F1_TOP3 INT DEFAULT -1;
DECLARE F2_TOP3 INT DEFAULT -1;
DECLARE F3_TOP3 INT DEFAULT -1;

DECLARE TOTAL INT DEFAULT 0;
DECLARE TEMP INT DEFAULT 0;
DECLARE EXIT1 INT DEFAULT 0;

DECLARE COMBINATIONS CURSOR FOR SELECT A.USER_ID, B.USER_ID, C.USER_ID FROM (SELECT USERS.USER_ID FROM USERS JOIN FRIENDSHIPS ON USERS.USER_ID = FRIENDSHIPS.USER_ID JOIN COMMENTS ON COMMENTS.COMMENTER_USER_ID = USERS.USER_ID WHERE USERS.GENDER='F' AND FRIENDSHIPS.FRIEND_ID = 20 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = USERS.USER_ID)  GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3) A CROSS JOIN (SELECT USERS.USER_ID  FROM USERS JOIN FRIENDSHIPS ON USERS.USER_ID = FRIENDSHIPS.USER_ID JOIN COMMENTS ON COMMENTS.COMMENTER_USER_ID = USERS.USER_ID WHERE USERS.GENDER='F' AND FRIENDSHIPS.FRIEND_ID = 20 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = USERS.USER_ID)  GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3) B CROSS JOIN (SELECT USERS.USER_ID FROM USERS JOIN FRIENDSHIPS ON USERS.USER_ID = FRIENDSHIPS.USER_ID JOIN COMMENTS ON COMMENTS.COMMENTER_USER_ID = USERS.USER_ID WHERE USERS.GENDER='F' AND FRIENDSHIPS.FRIEND_ID = 20 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = USERS.USER_ID)  GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3) C WHERE A.USER_ID != B.USER_ID AND B.USER_ID != C.USER_ID AND C.USER_ID != A.USER_ID;

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

OPEN COMBINATIONS;
read_loop: LOOP
    SET EXIT1 = 0;
	SET F1_ACC = 0;
	SET F2_ACC = 0;
	SET F3_ACC = 0;
	SET TEMP = 0;
	
	
    FETCH COMBINATIONS INTO F1,F2,F3;  
    IF done THEN
        LEAVE read_loop;
    END IF;
    SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F1_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F1 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F2_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F2 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F3_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F3 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	
	if (F1_ACC = 0 || F2_ACC = 0 || F3_ACC = 0) then
        set EXIT1 = -100;
	end if;
	
	if (EXIT1 = 0) then
        set TEMP = F1_ACC+F2_ACC+F3_ACC;
	end if;
	
	if (TOTAL < TEMP) then
        set TOTAL = TEMP;
	end if;
END LOOP;
CLOSE COMBINATIONS;

SET done = 0;
OPEN COMBINATIONS;
read_loop: LOOP
	SET EXIT1 = 0;
	SET F1_ACC = 0;
	SET F2_ACC = 0;
	SET F3_ACC = 0;
	SET TEMP = 0;
	
    FETCH COMBINATIONS INTO F1,F2,F3;  
    IF done THEN
        LEAVE read_loop;
    END IF;
    SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F1_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F1 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F2_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F2 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F3_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F3 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	
	if (F1_ACC = 0 || F2_ACC = 0 || F3_ACC = 0) then
        set EXIT1 = -100;
	end if;
	
	if (EXIT1 = 0) then
        set TEMP = F1_ACC+F2_ACC+F3_ACC;
	end if;
	
	if (TOTAL = TEMP) then
        set F1_TOP3 =F1;
	end if;
END LOOP;
CLOSE COMBINATIONS;

SET done = 0;
OPEN COMBINATIONS;
read_loop: LOOP
	SET EXIT1 = 0;
	SET F1_ACC = 0;
	SET F2_ACC = 0;
	SET F3_ACC = 0;
	SET TEMP = 0;
	
    FETCH COMBINATIONS INTO F1,F2,F3;  
    IF done THEN
        LEAVE read_loop;
    END IF;
    SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F1_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F1 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F2_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F2 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F3_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F3 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	
	if (F1_ACC = 0 || F2_ACC = 0 || F3_ACC = 0) then
        set EXIT1 = -100;
	end if;
	
	if (EXIT1 = 0) then
        set TEMP = F1_ACC+F2_ACC+F3_ACC;
	end if;
	
	if (TOTAL = TEMP) then
        set F2_TOP3 =F2;
	end if;
END LOOP;
CLOSE COMBINATIONS;

SET done = 0;
OPEN COMBINATIONS;
read_loop: LOOP
	SET EXIT1 = 0;
	SET F1_ACC = 0;
	SET F2_ACC = 0;
	SET F3_ACC = 0;
	SET TEMP = 0;
    FETCH COMBINATIONS INTO F1,F2,F3;  
    IF done THEN
        LEAVE read_loop;
    END IF;
    SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F1_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F1 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F2_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F2 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	SELECT COUNT(COMMENTER_USER_ID) AS ACC INTO F3_ACC FROM COMMENTS WHERE COMMENTER_USER_ID = F3 AND COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1 OR USER_ID=F2 OR USER_ID=F3) GROUP BY COMMENTS.COMMENTER_USER_ID HAVING COUNT(COMMENTS.COMMENTER_USER_ID) >= 3;
	
	if (F1_ACC = 0 || F2_ACC = 0 || F3_ACC = 0) then
        set EXIT1 = -100;
	end if;
	
	if (EXIT1 = 0) then
        set TEMP = F1_ACC+F2_ACC+F3_ACC;
	end if;
	
	if (TOTAL = TEMP) then
        set F3_TOP3 =F3;
	end if;
END LOOP;
CLOSE COMBINATIONS;

SELECT USERS.USER_ID , USERS.NAME , F1ACC.ACC, TOTALCOMMENTS.ACC FROM USERS, (SELECT COMMENTER_USER_ID,COUNT(COMMENTER_USER_ID) AS ACC FROM COMMENTS WHERE COMMENTS.POST_ID NOT IN ( SELECT POST_ID FROM POSTS WHERE USER_ID = 10 OR USER_ID = F1_TOP3 OR USER_ID=F2_TOP3 OR USER_ID=F3_TOP3) GROUP BY COMMENTS.COMMENTER_USER_ID) F1ACC , ( SELECT COMMENTER_USER_ID,COUNT(COMMENTER_USER_ID) AS ACC FROM COMMENTS GROUP BY COMMENTER_USER_ID) TOTALCOMMENTS WHERE USERS.USER_ID IN ( F1_TOP3, F2_TOP3, F3_TOP3) AND TOTALCOMMENTS.COMMENTER_USER_ID = USERS.USER_ID AND F1ACC.COMMENTER_USER_ID = USERS.USER_ID ORDER BY F1ACC.ACC DESC;
END$$
DELIMITER ;

CALL TOP3ACC();